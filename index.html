<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Web Audio Basics</title>
  <meta name="description" content="IIR Filter Demo for Web Audio API">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>

<div id="boombox">
	<div class="boombox-handle"></div>

	<div class="boombox-body">

		<section class="master-controls">
			<input type="range" id="volume" class="control-volume" min="0" max="2" value="1" list="gain-vals" step="0.01" data-action="volume" />
			<datalist id="gain-vals">
				<option value="0" label="min">
				<option value="2" label="max">
			</datalist>
			<label for="volume">VOL</label>

			<input type="range" id="panner" class="control-panner" list="pan-vals" min="-1" max="1" value="0" step="0.01" data-action="panner" />
			<datalist id="pan-vals">
				<option value="-1" label="left">
				<option value="1" label="right">
			</datalist>
			<label for="panner">PAN</label>

			<button class="control-power" role="switch" aria-checked="false" data-power="on">
				<span>On/Off</span>
			</button>
		</section>

		<section class="tape">

			<audio src="Gymnopedie.wav" crossorigin="anonymous" ></audio>

<!-- 			type="audio/mpeg" -->

			<button data-playing="false" class="tape-controls-play" role="switch" aria-checked="false">
				<span>Play/Pause</span>
			</button>
		</section>

	</div><!-- boombox-body -->
	
</div>
 <canvas id="canvas" width="512" height="256" ></canvas>

        <p id="controls">
          <input type="button" id="start_button" value="Start">
          &nbsp; &nbsp;
          <input type="button" id="stop_button" value="Stop">
        </p>
	
<script type="text/javascript">
	console.clear();
// instigate our audio context
// for cross browser
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();
// load some sound
const audioElement = document.querySelector('audio');
const track = audioCtx.createMediaElementSource(audioElement);
const playButton = document.querySelector('.tape-controls-play');
// play pause audio
playButton.addEventListener('click', function() {
	// check if context is in suspended state (autoplay policy)
	if (audioCtx.state === 'suspended') {
		audioCtx.resume();
	}
	if (this.dataset.playing === 'false') {
		audioElement.play();
		this.dataset.playing = 'true';
	// if track is playing pause it
	} else if (this.dataset.playing === 'true') {
		audioElement.pause();
		this.dataset.playing = 'false';
	}
	let state = this.getAttribute('aria-checked') === "true" ? true : false;
	this.setAttribute( 'aria-checked', state ? "false" : "true" );
}, false);
// if track ends
audioElement.addEventListener('ended', () => {
	playButton.dataset.playing = 'false';
	playButton.setAttribute( "aria-checked", "false" );
}, false);
// volume
const gainNode = audioCtx.createGain();
const volumeControl = document.querySelector('[data-action="volume"]');
volumeControl.addEventListener('input', function() {
	gainNode.gain.value = this.value;
}, false);
// panning
const pannerOptions = {pan: 0};
const panner = new StereoPannerNode(audioCtx, pannerOptions);
const pannerControl = document.querySelector('[data-action="panner"]');
pannerControl.addEventListener('input', function() {
	panner.pan.value = this.value;
}, false);
// connect our graph
track.connect(gainNode).connect(panner).connect(audioCtx.destination);
// Track credit: Outfoxing the Fox by Kevin MacLeod under Creative Commons

// Hacks to deal with different function names in different browsers
            window.requestAnimFrame = (function(){
              return  window.requestAnimationFrame       ||
                      window.webkitRequestAnimationFrame ||
                      window.mozRequestAnimationFrame    ||
                      function(callback, element){
                        window.setTimeout(callback, 1000 / 60);
                      };
            })();
            window.AudioContext = (function(){
                return  window.webkitAudioContext || window.AudioContext || window.mozAudioContext;
            })();
            // Global Variables for Audio
            var audioContext;
            var audioBuffer;
            var sourceNode;
            var analyserNode;
            var javascriptNode;
            var audioData = null;
            var audioPlaying = false;
            var sampleSize = 1024;  // number of samples to collect before analyzing data
            var amplitudeArray;     // array to hold time domain data
            // This must be hosted on the same server as this page - otherwise you get a Cross Site Scripting error
            var audioUrl = "viper.mp3";
            // Global Variables for the Graphics
            var canvasWidth  = 512;
            var canvasHeight = 256;
            var ctx;
            $(document).ready(function() {
                ctx = $("#canvas").get()[0].getContext("2d");
                // the AudioContext is the primary 'container' for all your audio node objects
                try {
                    audioContext = new AudioContext();
                } catch(e) {
                    alert('Web Audio API is not supported in this browser');
                }
                // When the Start button is clicked, finish setting up the audio nodes, play the sound,
                // gather samples for the analysis, update the canvas
                $("#start_button").on('click', function(e) {
                    e.preventDefault();
                    // Set up the audio Analyser, the Source Buffer and javascriptNode
                    setupAudioNodes();
                    // setup the event handler that is triggered every time enough samples have been collected
                    // trigger the audio analysis and draw the results
                    javascriptNode.onaudioprocess = function () {
                        // get the Time Domain data for this sample
                        analyserNode.getByteTimeDomainData(amplitudeArray);
                        // draw the display if the audio is playing
                        if (audioPlaying == true) {
                            requestAnimFrame(drawTimeDomain);
                        }
                    }
                    // Load the Audio the first time through, otherwise play it from the buffer
                    if(audioData == null) {
                        loadSound(audioUrl);
                    } else {
                        playSound(audioData);
                    }
                });
                // Stop the audio playing
                $("#stop_button").on('click', function(e) {
                    e.preventDefault();
                    sourceNode.stop(0);
                    audioPlaying = false;
                });
            });
            function setupAudioNodes() {
                sourceNode     = audioContext.createBufferSource();
                analyserNode   = audioContext.createAnalyser();
                javascriptNode = audioContext.createScriptProcessor(sampleSize, 1, 1);
                // Create the array for the data values
                amplitudeArray = new Uint8Array(analyserNode.frequencyBinCount);
                // Now connect the nodes together
                sourceNode.connect(audioContext.destination);
                sourceNode.connect(analyserNode);
                analyserNode.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);
            }
            // Load the audio from the URL via Ajax and store it in global variable audioData
            // Note that the audio load is asynchronous
            function loadSound(url) {
                var request = new XMLHttpRequest();
                request.open('GET', url, true);
                request.responseType = 'arraybuffer';
                // When loaded, decode the data and play the sound
                request.onload = function () {
                    audioContext.decodeAudioData(request.response, function (buffer) {
                        audioData = buffer;
                        playSound(audioData);
                    }, onError);
                }
                request.send();
            }
            // Play the audio and loop until stopped
            function playSound(buffer) {
                sourceNode.buffer = buffer;
                sourceNode.start(0);    // Play the sound now
                sourceNode.loop = true;
                audioPlaying = true;
            }
            function onError(e) {
                console.log(e);
            }
            function drawTimeDomain() {
                clearCanvas();
                for (var i = 0; i < amplitudeArray.length; i++) {
                    var value = amplitudeArray[i] / 256;
                    var y = canvasHeight - (canvasHeight * value) - 1;
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(i, y, 1, 1);
                }
            }
            function clearCanvas() {
                ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            }
</script>

</body>
</html>
